# üìã EXPLICA√á√ÉO: Valores da NFSE vs Valor Pago

## Data: 23/10/2025

---

## üéØ CONCEITOS IMPORTANTES:

### 1. **Valor da NFSE (Nota Fiscal)**
- **O que √©:** Valor que aparece na Nota Fiscal de Servi√ßo Eletr√¥nica
- **Como √© calculado:** **70% do benef√≠cio/sal√°rio do idoso**
- **Exemplo:**
  - Benef√≠cio do idoso: R$ 1.760,38
  - 70% do benef√≠cio: **R$ 1.232,27** ‚Üê Este √© o valor da NFSE
- **Onde aparece no PDF:**
  ```
  Descri√ß√£o do Item | Quantidade | Valor | Valor L√≠quido
  Valor referente... | 1,00000 | 1.232,26 | 1.232,26 ‚Üê VALOR DA NFSE
  ```

### 2. **Valor Pago (Mensalidade Total)**
- **O que √©:** Valor TOTAL que o respons√°vel paga pela estadia do idoso
- **Como √© calculado:** **Mensalidade Base** (valor fixo definido pela institui√ß√£o)
- **Exemplo:**
  - Mensalidade Base: **R$ 3.225,00** ‚Üê Este √© o valor pago
- **Composi√ß√£o:**
  - Parte 1: 70% do benef√≠cio (pago via NFSE) = R$ 1.232,27
  - Parte 2: Doa√ß√£o do respons√°vel = R$ 1.992,73
  - **Total = R$ 3.225,00**

### 3. **Doa√ß√£o**
- **O que √©:** Diferen√ßa entre o valor pago e a NFSE
- **Como √© calculado:** Valor Pago - Valor NFSE
- **Exemplo:**
  - Valor Pago: R$ 3.225,00
  - Valor NFSE: R$ 1.232,27
  - **Doa√ß√£o: R$ 1.992,73** ‚Üê Valor que o respons√°vel doa

---

## üìä EXEMPLO COMPLETO - Maria Ines Jung:

### Dados do Idoso:
- **Nome:** Maria Ines Jung
- **Mensalidade Base:** R$ 3.225,00 (valor que ela paga para ficar no lar)
- **Benef√≠cio (Sal√°rio):** R$ 1.760,38 (aposentadoria/pens√£o)
- **Tipo:** REGULAR (70% + doa√ß√£o)

### C√°lculos:
1. **70% do Benef√≠cio:**
   - R$ 1.760,38 √ó 70% = **R$ 1.232,27**
   - Este √© o valor que vai na NFSE

2. **Doa√ß√£o:**
   - Mensalidade: R$ 3.225,00
   - Menos NFSE: R$ 1.232,27
   - **Doa√ß√£o: R$ 1.992,73**

### Como o Respons√°vel Paga:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MENSALIDADE TOTAL: R$ 3.225,00 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Parte 1 (NFSE):    R$ 1.232,27 ‚îÇ ‚Üê 70% do benef√≠cio
‚îÇ Parte 2 (Doa√ß√£o):  R$ 1.992,73 ‚îÇ ‚Üê Complemento do respons√°vel
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è PROBLEMA COMUM: Gemini Extrai Valor Errado

### O que acontece:
A IA Gemini √†s vezes confunde os valores e extrai:
- ‚ùå Valor da mensalidade (R$ 3.225,00) ao inv√©s de
- ‚úÖ Valor da NFSE (R$ 1.232,27)

### Onde est√° no PDF:
```
PDF da NFSE:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Descri√ß√£o           | Valor | Valor L√≠quido ‚îÇ
‚îÇ Valor referente...  | 1.232,26 | 1.232,26  ‚îÇ ‚Üê CORRETO
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Em outro lugar do PDF pode ter:
- Valor total: R$ 3.225,00  ‚Üê ERRADO (n√£o √© da NFSE!)
- Mensalidade: R$ 3.225,00  ‚Üê ERRADO (n√£o √© da NFSE!)
```

---

## ‚úÖ SOLU√á√ÉO IMPLEMENTADA:

### 1. Prompt Melhorado para Gemini
**Arquivo:** `src/utils/geminiExtractor.ts`

Instru√ß√µes adicionadas:
```
‚ö†Ô∏è MUITO IMPORTANTE - Extraia o "Valor L√≠quido" da tabela de itens/servi√ßos
* Procure por uma TABELA com colunas: "Descri√ß√£o do Item", "Quantidade", "Valor", "Valor L√≠quido"
* Use SEMPRE o valor da coluna "Valor L√≠quido" (√∫ltima coluna da tabela de itens)
* N√ÉO use valores de outras partes do PDF (totais, mensalidades, etc.)
```

### 2. Valida√ß√£o Visual no Sistema
**Arquivo:** `src/components/Dashboard/PaymentModal.tsx`

Quando o valor extra√≠do estiver diferente do esperado (70% do benef√≠cio):
- ‚ö†Ô∏è Mostra alerta visual em amarelo
- Compara valor extra√≠do vs valor esperado
- Permite ajuste manual se necess√°rio

### 3. Valida√ß√£o Flex√≠vel
- **Toler√¢ncia:** Aceita diferen√ßa de at√© 10%
- **Bloqueio:** S√≥ bloqueia se diferen√ßa > 10%
- **Aviso:** Mostra alerta se diferen√ßa > R$ 1,00

---

## üéì PARA ENTENDER:

### Por que 70%?
A legisla√ß√£o permite que institui√ß√µes de longa perman√™ncia cobrem at√© 70% do benef√≠cio/sal√°rio do idoso via nota fiscal de servi√ßo.

### Por que o respons√°vel paga mais?
O custo real da estadia √© maior que 70% do benef√≠cio. A diferen√ßa √© considerada **doa√ß√£o volunt√°ria** do respons√°vel.

### O recibo de doa√ß√£o √© importante?
Sim! O respons√°vel pode declarar a doa√ß√£o no Imposto de Renda e ter benef√≠cios fiscais.

---

## üìù REGRA DE NEG√ìCIO:

| Item | Valor | Observa√ß√£o |
|------|-------|------------|
| **Benef√≠cio do Idoso** | R$ 1.760,38 | Aposentadoria/Pens√£o |
| **70% do Benef√≠cio (NFSE)** | R$ 1.232,27 | Valor que vai na nota fiscal |
| **Mensalidade Base** | R$ 3.225,00 | Valor total que o idoso paga |
| **Doa√ß√£o** | R$ 1.992,73 | Diferen√ßa = doa√ß√£o do respons√°vel |

**Importante:**
- ‚úÖ Valor da NFSE = 70% do benef√≠cio (R$ 1.232,27)
- ‚úÖ Valor Pago = Mensalidade completa (R$ 3.225,00)
- ‚ùå Valor da NFSE ‚â† Valor Pago (s√£o diferentes!)

---

## üîß A√á√ïES DO USU√ÅRIO:

### Quando o sistema mostrar alerta:
1. **Verificar PDF:**
   - Abrir o PDF da NFSE
   - Procurar a tabela de itens/servi√ßos
   - Confirmar o "Valor L√≠quido"

2. **Se valor estiver correto no PDF:**
   - Ignorar o alerta
   - Usar o valor extra√≠do
   - Sistema permite continuar

3. **Se valor estiver errado:**
   - Corrigir manualmente no campo "Valor Pago"
   - Sistema salva o valor corrigido
   - Recibo ser√° gerado com valor correto

4. **Se benef√≠cio do idoso mudou:**
   - Ir em "Editar Idoso"
   - Atualizar o campo "Benef√≠cio (Sal√°rio)"
   - Voltar e fazer novo pagamento

---

**Status:** üü¢ **DOCUMENTADO E IMPLEMENTADO**
**Data:** 23/10/2025 20:45


